(function(){"use strict";function tt(e,t,n=0,i=e.length-1,c=ut){for(;i>n;){if(i-n>600){const a=i-n+1,f=t-n+1,u=Math.log(a),l=.5*Math.exp(2*u/3),h=.5*Math.sqrt(u*l*(a-l)/a)*(f-a/2<0?-1:1),m=Math.max(n,Math.floor(t-f*l/a+h)),g=Math.min(i,Math.floor(t+(a-f)*l/a+h));tt(e,t,m,g,c)}const o=e[t];let r=n,s=i;for(R(e,n,t),c(e[i],o)>0&&R(e,n,i);r<s;){for(R(e,r,s),r++,s--;c(e[r],o)<0;)r++;for(;c(e[s],o)>0;)s--}c(e[n],o)===0?R(e,n,s):(s++,R(e,s,i)),s<=t&&(n=s+1),t<=s&&(i=s-1)}}function R(e,t,n){const i=e[t];e[t]=e[n],e[n]=i}function ut(e,t){return e<t?-1:e>t?1:0}class nt{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let n=this.data;const i=[];if(!H(t,n))return i;const c=this.toBBox,o=[];for(;n;){for(let r=0;r<n.children.length;r++){const s=n.children[r],a=n.leaf?c(s):s;H(t,a)&&(n.leaf?i.push(s):V(t,a)?this._all(s,i):o.push(s))}n=o.pop()}return i}collides(t){let n=this.data;if(!H(t,n))return!1;const i=[];for(;n;){for(let c=0;c<n.children.length;c++){const o=n.children[c],r=n.leaf?this.toBBox(o):o;if(H(t,r)){if(n.leaf||V(t,r))return!0;i.push(o)}}n=i.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let i=0;i<t.length;i++)this.insert(t[i]);return this}let n=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=n;else if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){const i=this.data;this.data=n,n=i}this._insert(n,this.data.height-n.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=O([]),this}remove(t,n){if(!t)return this;let i=this.data;const c=this.toBBox(t),o=[],r=[];let s,a,f;for(;i||o.length;){if(i||(i=o.pop(),a=o[o.length-1],s=r.pop(),f=!0),i.leaf){const u=ft(t,i.children,n);if(u!==-1)return i.children.splice(u,1),o.push(i),this._condense(o),this}!f&&!i.leaf&&V(i,c)?(o.push(i),r.push(s),s=0,a=i,i=i.children[0]):a?(s++,i=a.children[s],f=!1):i=null}return this}toBBox(t){return t}compareMinX(t,n){return t.minX-n.minX}compareMinY(t,n){return t.minY-n.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,n){const i=[];for(;t;)t.leaf?n.push(...t.children):i.push(...t.children),t=i.pop();return n}_build(t,n,i,c){const o=i-n+1;let r=this._maxEntries,s;if(o<=r)return s=O(t.slice(n,i+1)),N(s,this.toBBox),s;c||(c=Math.ceil(Math.log(o)/Math.log(r)),r=Math.ceil(o/Math.pow(r,c-1))),s=O([]),s.leaf=!1,s.height=c;const a=Math.ceil(o/r),f=a*Math.ceil(Math.sqrt(r));et(t,n,i,f,this.compareMinX);for(let u=n;u<=i;u+=f){const l=Math.min(u+f-1,i);et(t,u,l,a,this.compareMinY);for(let h=u;h<=l;h+=a){const m=Math.min(h+a-1,l);s.children.push(this._build(t,h,m,c-1))}}return N(s,this.toBBox),s}_chooseSubtree(t,n,i,c){for(;c.push(n),!(n.leaf||c.length-1===i);){let o=1/0,r=1/0,s;for(let a=0;a<n.children.length;a++){const f=n.children[a],u=U(f),l=xt(t,f)-u;l<r?(r=l,o=u<o?u:o,s=f):l===r&&u<o&&(o=u,s=f)}n=s||n.children[0]}return n}_insert(t,n,i){const c=i?t:this.toBBox(t),o=[],r=this._chooseSubtree(c,this.data,n,o);for(r.children.push(t),Q(r,c);n>=0&&o[n].children.length>this._maxEntries;)this._split(o,n),n--;this._adjustParentBBoxes(c,o,n)}_split(t,n){const i=t[n],c=i.children.length,o=this._minEntries;this._chooseSplitAxis(i,o,c);const r=this._chooseSplitIndex(i,o,c),s=O(i.children.splice(r,i.children.length-r));s.height=i.height,s.leaf=i.leaf,N(i,this.toBBox),N(s,this.toBBox),n?t[n-1].children.push(s):this._splitRoot(i,s)}_splitRoot(t,n){this.data=O([t,n]),this.data.height=t.height+1,this.data.leaf=!1,N(this.data,this.toBBox)}_chooseSplitIndex(t,n,i){let c,o=1/0,r=1/0;for(let s=n;s<=i-n;s++){const a=$(t,0,s,this.toBBox),f=$(t,s,i,this.toBBox),u=gt(a,f),l=U(a)+U(f);u<o?(o=u,c=s,r=l<r?l:r):u===o&&l<r&&(r=l,c=s)}return c||i-n}_chooseSplitAxis(t,n,i){const c=t.leaf?this.compareMinX:mt,o=t.leaf?this.compareMinY:dt,r=this._allDistMargin(t,n,i,c),s=this._allDistMargin(t,n,i,o);r<s&&t.children.sort(c)}_allDistMargin(t,n,i,c){t.children.sort(c);const o=this.toBBox,r=$(t,0,n,o),s=$(t,i-n,i,o);let a=z(r)+z(s);for(let f=n;f<i-n;f++){const u=t.children[f];Q(r,t.leaf?o(u):u),a+=z(r)}for(let f=i-n-1;f>=n;f--){const u=t.children[f];Q(s,t.leaf?o(u):u),a+=z(s)}return a}_adjustParentBBoxes(t,n,i){for(let c=i;c>=0;c--)Q(n[c],t)}_condense(t){for(let n=t.length-1,i;n>=0;n--)t[n].children.length===0?n>0?(i=t[n-1].children,i.splice(i.indexOf(t[n]),1)):this.clear():N(t[n],this.toBBox)}}function ft(e,t,n){if(!n)return t.indexOf(e);for(let i=0;i<t.length;i++)if(n(e,t[i]))return i;return-1}function N(e,t){$(e,0,e.children.length,t,e)}function $(e,t,n,i,c){c||(c=O(null)),c.minX=1/0,c.minY=1/0,c.maxX=-1/0,c.maxY=-1/0;for(let o=t;o<n;o++){const r=e.children[o];Q(c,e.leaf?i(r):r)}return c}function Q(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function mt(e,t){return e.minX-t.minX}function dt(e,t){return e.minY-t.minY}function U(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function z(e){return e.maxX-e.minX+(e.maxY-e.minY)}function xt(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function gt(e,t){const n=Math.max(e.minX,t.minX),i=Math.max(e.minY,t.minY),c=Math.min(e.maxX,t.maxX),o=Math.min(e.maxY,t.maxY);return Math.max(0,c-n)*Math.max(0,o-i)}function V(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function H(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function O(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function et(e,t,n,i,c){const o=[t,n];for(;o.length;){if(n=o.pop(),t=o.pop(),n-t<=i)continue;const r=t+Math.ceil((n-t)/i/2)*i;tt(e,r,t,n,c),o.push(t,r,r,n)}}class pt{constructor(t=[],n=(i,c)=>i<c?-1:i>c?1:0){if(this.data=t,this.length=this.data.length,this.compare=n,this.length>0)for(let i=(this.length>>1)-1;i>=0;i--)this._down(i)}push(t){this.data.push(t),this._up(this.length++)}pop(){if(this.length===0)return;const t=this.data[0],n=this.data.pop();return--this.length>0&&(this.data[0]=n,this._down(0)),t}peek(){return this.data[0]}_up(t){const{data:n,compare:i}=this,c=n[t];for(;t>0;){const o=t-1>>1,r=n[o];if(i(c,r)>=0)break;n[t]=r,t=o}n[t]=c}_down(t){const{data:n,compare:i}=this,c=this.length>>1,o=n[t];for(;t<c;){let r=(t<<1)+1;const s=r+1;if(s<this.length&&i(n[s],n[r])<0&&(r=s),i(n[r],o)>=0)break;n[t]=n[r],t=r}n[t]=o}}function Mt(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var J={exports:{}},Xt=function(t,n,i,c){var o=t[0],r=t[1],s=!1;i===void 0&&(i=0),c===void 0&&(c=n.length);for(var a=(c-i)/2,f=0,u=a-1;f<a;u=f++){var l=n[i+f*2+0],h=n[i+f*2+1],m=n[i+u*2+0],g=n[i+u*2+1],d=h>r!=g>r&&o<(m-l)*(r-h)/(g-h)+l;d&&(s=!s)}return s},Yt=function(t,n,i,c){var o=t[0],r=t[1],s=!1;i===void 0&&(i=0),c===void 0&&(c=n.length);for(var a=c-i,f=0,u=a-1;f<a;u=f++){var l=n[f+i][0],h=n[f+i][1],m=n[u+i][0],g=n[u+i][1],d=h>r!=g>r&&o<(m-l)*(r-h)/(g-h)+l;d&&(s=!s)}return s},it=Xt,st=Yt;J.exports=function(t,n,i,c){return n.length>0&&Array.isArray(n[0])?st(t,n,i,c):it(t,n,i,c)},J.exports.nested=st,J.exports.flat=it;var Bt=J.exports,wt=Mt(Bt);const E=11102230246251565e-32,I=134217729,_t=(3+8*E)*E;function k(e,t,n,i,c){let o,r,s,a,f=t[0],u=i[0],l=0,h=0;u>f==u>-f?(o=f,f=t[++l]):(o=u,u=i[++h]);let m=0;if(l<e&&h<n)for(u>f==u>-f?(r=f+o,s=o-(r-f),f=t[++l]):(r=u+o,s=o-(r-u),u=i[++h]),o=r,s!==0&&(c[m++]=s);l<e&&h<n;)u>f==u>-f?(r=o+f,a=r-o,s=o-(r-a)+(f-a),f=t[++l]):(r=o+u,a=r-o,s=o-(r-a)+(u-a),u=i[++h]),o=r,s!==0&&(c[m++]=s);for(;l<e;)r=o+f,a=r-o,s=o-(r-a)+(f-a),f=t[++l],o=r,s!==0&&(c[m++]=s);for(;h<n;)r=o+u,a=r-o,s=o-(r-a)+(u-a),u=i[++h],o=r,s!==0&&(c[m++]=s);return(o!==0||m===0)&&(c[m++]=o),m}function yt(e,t){let n=t[0];for(let i=1;i<e;i++)n+=t[i];return n}function G(e){return new Float64Array(e)}const It=(3+16*E)*E,St=(2+12*E)*E,vt=(9+64*E)*E*E,F=G(4),ot=G(8),rt=G(12),ct=G(16),v=G(4);function Dt(e,t,n,i,c,o,r){let s,a,f,u,l,h,m,g,d,M,x,p,B,X,Y,w,y,_;const S=e-c,D=n-c,P=t-o,C=i-o;X=S*C,h=I*S,m=h-(h-S),g=S-m,h=I*C,d=h-(h-C),M=C-d,Y=g*M-(X-m*d-g*d-m*M),w=P*D,h=I*P,m=h-(h-P),g=P-m,h=I*D,d=h-(h-D),M=D-d,y=g*M-(w-m*d-g*d-m*M),x=Y-y,l=Y-x,F[0]=Y-(x+l)+(l-y),p=X+x,l=p-X,B=X-(p-l)+(x-l),x=B-w,l=B-x,F[1]=B-(x+l)+(l-w),_=p+x,l=_-p,F[2]=p-(_-l)+(x-l),F[3]=_;let A=yt(4,F),q=St*r;if(A>=q||-A>=q||(l=e-S,s=e-(S+l)+(l-c),l=n-D,f=n-(D+l)+(l-c),l=t-P,a=t-(P+l)+(l-o),l=i-C,u=i-(C+l)+(l-o),s===0&&a===0&&f===0&&u===0)||(q=vt*r+_t*Math.abs(A),A+=S*u+C*s-(P*f+D*a),A>=q||-A>=q))return A;X=s*C,h=I*s,m=h-(h-s),g=s-m,h=I*C,d=h-(h-C),M=C-d,Y=g*M-(X-m*d-g*d-m*M),w=a*D,h=I*a,m=h-(h-a),g=a-m,h=I*D,d=h-(h-D),M=D-d,y=g*M-(w-m*d-g*d-m*M),x=Y-y,l=Y-x,v[0]=Y-(x+l)+(l-y),p=X+x,l=p-X,B=X-(p-l)+(x-l),x=B-w,l=B-x,v[1]=B-(x+l)+(l-w),_=p+x,l=_-p,v[2]=p-(_-l)+(x-l),v[3]=_;const j=k(4,F,4,v,ot);X=S*u,h=I*S,m=h-(h-S),g=S-m,h=I*u,d=h-(h-u),M=u-d,Y=g*M-(X-m*d-g*d-m*M),w=P*f,h=I*P,m=h-(h-P),g=P-m,h=I*f,d=h-(h-f),M=f-d,y=g*M-(w-m*d-g*d-m*M),x=Y-y,l=Y-x,v[0]=Y-(x+l)+(l-y),p=X+x,l=p-X,B=X-(p-l)+(x-l),x=B-w,l=B-x,v[1]=B-(x+l)+(l-w),_=p+x,l=_-p,v[2]=p-(_-l)+(x-l),v[3]=_;const $t=k(j,ot,4,v,rt);X=s*u,h=I*s,m=h-(h-s),g=s-m,h=I*u,d=h-(h-u),M=u-d,Y=g*M-(X-m*d-g*d-m*M),w=a*f,h=I*a,m=h-(h-a),g=a-m,h=I*f,d=h-(h-f),M=f-d,y=g*M-(w-m*d-g*d-m*M),x=Y-y,l=Y-x,v[0]=Y-(x+l)+(l-y),p=X+x,l=p-X,B=X-(p-l)+(x-l),x=B-w,l=B-x,v[1]=B-(x+l)+(l-w),_=p+x,l=_-p,v[2]=p-(_-l)+(x-l),v[3]=_;const Qt=k($t,rt,4,v,ct);return ct[Qt-1]}function Pt(e,t,n,i,c,o){const r=(t-o)*(n-c),s=(e-c)*(i-o),a=r-s,f=Math.abs(r+s);return Math.abs(a)>=It*f?a:-Dt(e,t,n,i,c,o,f)}function Ct(e,t,n){t=Math.max(0,t===void 0?2:t),n=n||0;const i=Ot(e),c=new nt(16);c.toBBox=function(h){return{minX:h[0],minY:h[1],maxX:h[0],maxY:h[1]}},c.compareMinX=function(h,m){return h[0]-m[0]},c.compareMinY=function(h,m){return h[1]-m[1]},c.load(e);const o=[];let r;for(let h=0;h<i.length;h++){const m=i[h];c.remove(m),r=at(m,r),o.push(r)}const s=new nt(16);for(let h=0;h<o.length;h++)s.insert(K(o[h]));const a=t*t,f=n*n;for(;o.length;){const h=o.shift(),m=h.p,g=h.next.p,d=W(m,g);if(d<f)continue;const M=d/a,x=At(c,h.prev.p,m,g,h.next.next.p,M,s);x&&Math.min(W(x,m),W(x,g))<=M&&(o.push(h),o.push(at(x,h)),c.remove(x),s.remove(h),s.insert(K(h)),s.insert(K(h.next)))}let u=r;const l=[];do l.push(u.p),u=u.next;while(u!==r);return l.push(u.p),l}function At(e,t,n,i,c,o,r){const s=new pt([],Et);let a=e.data;for(;a;){for(let f=0;f<a.children.length;f++){const u=a.children[f],l=a.leaf?Z(u,n,i):qt(n,i,u);l>o||s.push({node:u,dist:l})}for(;s.length&&!s.peek().node.children;){const f=s.pop(),u=f.node,l=Z(u,t,n),h=Z(u,i,c);if(f.dist<l&&f.dist<h&&ht(n,u,r)&&ht(i,u,r))return u}a=s.pop(),a&&(a=a.node)}return null}function Et(e,t){return e.dist-t.dist}function qt(e,t,n){if(lt(e,n)||lt(t,n))return 0;const i=T(e[0],e[1],t[0],t[1],n.minX,n.minY,n.maxX,n.minY);if(i===0)return 0;const c=T(e[0],e[1],t[0],t[1],n.minX,n.minY,n.minX,n.maxY);if(c===0)return 0;const o=T(e[0],e[1],t[0],t[1],n.maxX,n.minY,n.maxX,n.maxY);if(o===0)return 0;const r=T(e[0],e[1],t[0],t[1],n.minX,n.maxY,n.maxX,n.maxY);return r===0?0:Math.min(i,c,o,r)}function lt(e,t){return e[0]>=t.minX&&e[0]<=t.maxX&&e[1]>=t.minY&&e[1]<=t.maxY}function ht(e,t,n){const i=Math.min(e[0],t[0]),c=Math.min(e[1],t[1]),o=Math.max(e[0],t[0]),r=Math.max(e[1],t[1]),s=n.search({minX:i,minY:c,maxX:o,maxY:r});for(let a=0;a<s.length;a++)if(Nt(s[a].p,s[a].next.p,e,t))return!1;return!0}function L(e,t,n){return Pt(e[0],e[1],t[0],t[1],n[0],n[1])}function Nt(e,t,n,i){return e!==i&&t!==n&&L(e,t,n)>0!=L(e,t,i)>0&&L(n,i,e)>0!=L(n,i,t)>0}function K(e){const t=e.p,n=e.next.p;return e.minX=Math.min(t[0],n[0]),e.minY=Math.min(t[1],n[1]),e.maxX=Math.max(t[0],n[0]),e.maxY=Math.max(t[1],n[1]),e}function Ot(e){let t=e[0],n=e[0],i=e[0],c=e[0];for(let s=0;s<e.length;s++){const a=e[s];a[0]<t[0]&&(t=a),a[0]>i[0]&&(i=a),a[1]<n[1]&&(n=a),a[1]>c[1]&&(c=a)}const o=[t,n,i,c],r=o.slice();for(let s=0;s<e.length;s++)wt(e[s],o)||r.push(e[s]);return Lt(r)}function at(e,t){const n={p:e,prev:null,next:null,minX:0,minY:0,maxX:0,maxY:0};return t?(n.next=t.next,n.prev=t,t.next.prev=n,t.next=n):(n.prev=n,n.next=n),n}function W(e,t){const n=e[0]-t[0],i=e[1]-t[1];return n*n+i*i}function Z(e,t,n){let i=t[0],c=t[1],o=n[0]-i,r=n[1]-c;if(o!==0||r!==0){const s=((e[0]-i)*o+(e[1]-c)*r)/(o*o+r*r);s>1?(i=n[0],c=n[1]):s>0&&(i+=o*s,c+=r*s)}return o=e[0]-i,r=e[1]-c,o*o+r*r}function T(e,t,n,i,c,o,r,s){const a=n-e,f=i-t,u=r-c,l=s-o,h=e-c,m=t-o,g=a*a+f*f,d=a*u+f*l,M=u*u+l*l,x=a*h+f*m,p=u*h+l*m,B=g*M-d*d;let X,Y,w=B,y=B;B===0?(X=0,w=1,Y=p,y=M):(X=d*p-M*x,Y=g*p-d*x,X<0?(X=0,Y=p,y=M):X>w&&(X=w,Y=p+d,y=M)),Y<0?(Y=0,-x<0?X=0:-x>g?X=w:(X=-x,w=g)):Y>y&&(Y=y,-x+d<0?X=0:-x+d>g?X=w:(X=-x+d,w=g));const _=X===0?0:X/w,S=Y===0?0:Y/y,D=(1-_)*e+_*n,P=(1-_)*t+_*i,C=(1-S)*c+S*r,A=(1-S)*o+S*s,q=C-D,j=A-P;return q*q+j*j}function Ft(e,t){return e[0]===t[0]?e[1]-t[1]:e[0]-t[0]}function Lt(e){e.sort(Ft);const t=[];for(let i=0;i<e.length;i++){for(;t.length>=2&&L(t[t.length-2],t[t.length-1],e[i])<=0;)t.pop();t.push(e[i])}const n=[];for(let i=e.length-1;i>=0;i--){for(;n.length>=2&&L(n[n.length-2],n[n.length-1],e[i])<=0;)n.pop();n.push(e[i])}return n.pop(),t.pop(),t.concat(n)}function b(e,t){if(e.length<=2)return e;let n=0,i=0;const c=e[0],o=e[e.length-1];for(let r=1;r<e.length-1;r++){const s=Rt(e[r],c,o);s>n&&(n=s,i=r)}if(n>t){const r=b(e.slice(0,i+1),t),s=b(e.slice(i),t);return r.slice(0,-1).concat(s)}else return[c,o]}function Rt(e,t,n){const[i,c]=e,[o,r]=t,[s,a]=n,f=i-o,u=c-r,l=s-o,h=a-r,m=f*l+u*h,g=l*l+h*h;if(g===0)return Math.sqrt(f*f+u*u);const d=m/g;let M,x;d<0?(M=o,x=r):d>1?(M=s,x=a):(M=o+d*l,x=r+d*h);const p=i-M,B=c-x;return Math.sqrt(p*p+B*B)}self.onmessage=e=>{const{type:t,points:n,concavity:i,groupField:c,method:o="concave",padding:r=.05}=e.data;if(t==="generate")try{const s=new Map;n.forEach(l=>{const h=String(l[c]??"undefined"),m=s.get(h)??[];m.push(l),s.set(h,m)});const a=[],f=s.size;let u=0;s.forEach((l,h)=>{if(l.length<3){u++;return}try{const m=l.map(p=>[p.longitude,p.latitude]);let g=Ct(m,i,0);if(g.length<3){u++;return}(g[0][0]!==g[g.length-1][0]||g[0][1]!==g[g.length-1][1])&&g.push([...g[0]]);let d=g;if(o==="simplified"){const p=r>0?r*1e-4:5e-5;d=b(d,p),d.length>0&&(d[0][0]!==d[d.length-1][0]||d[0][1]!==d[d.length-1][1])&&d.push([...d[0]])}const M={groupId:h,pointCount:l.length,method:o},x=l[0];Object.keys(x).forEach(p=>{if(["id","longitude","latitude"].includes(p))return;const B=l.map(Y=>Y[p]),X=Array.from(new Set(B));X.length===1?M[p]=X[0]:(M[p]=X[0],M[`${p}_unique_count`]=X.length)}),a.push({id:`polygon-${h}`,groupId:h,groupField:c,coordinates:d,properties:M}),u++,u%10===0&&self.postMessage({type:"progress",groupsProcessed:u,totalGroups:f,currentGroup:h})}catch(m){console.error(`Failed to generate polygon for group ${h}:`,m),u++}}),self.postMessage({type:"complete",polygons:a})}catch(s){self.postMessage({type:"error",message:s.message||"Failed to generate polygons"})}}})();
